import { CurrentWeather } from '../../common/WeatherDataModel'
import { getCurrentWeather, getAirQuality, getDailyForecast } from '../../common/WeatherAPI'
import { CityManager } from '../../common/CityManager'
import router from '@ohos.router'

@Entry
@Component
struct MainPage {
  @State currentWeather: CurrentWeather = new CurrentWeather()
  @State isLoading: boolean = false
  @State errorMessage: string = ''
  @State aqi: number = 0
  @State aqiDescription: string = ''
  @State highTemp: number = 0
  @State lowTemp: number = 0
  
  private cityManager: CityManager = CityManager.getInstance()
  
  aboutToAppear(): void {
    // åˆå§‹åŒ–æ—¶è·å–å¤©æ°”æ•°æ®
    this.refreshWeather()
  }
  
  // é¡µé¢æ¯æ¬¡æ˜¾ç¤ºæ—¶éƒ½ä¼šè°ƒç”¨ï¼ˆä»å…¶ä»–é¡µé¢è¿”å›æ—¶ä¹Ÿä¼šè§¦å‘ï¼‰
  onPageShow(): void {
    // ä»åŸå¸‚é¡µé¢è¿”å›æ—¶ï¼Œåˆ·æ–°å¤©æ°”æ•°æ®
    this.refreshWeather()
  }
  
  // åˆ·æ–°å¤©æ°”æ•°æ®
  async refreshWeather() {
    this.isLoading = true
    this.errorMessage = ''
    
    try {
      // è·å–å½“å‰åŸå¸‚
      let location = '101300601' // é»˜è®¤æ¢§å·ä¸‡ç§€
      let latitude = 23.48
      let longitude = 111.32
      
      const currentCity = this.cityManager.getCurrentCity()
      if (currentCity && currentCity.id) {
        location = currentCity.id
        latitude = currentCity.latitude
        longitude = currentCity.longitude
      }
      
      // è·å–å®æ—¶å¤©æ°”
      const weather = await getCurrentWeather(location)
      // APIä¸è¿”å›åŸå¸‚åæ—¶å›å¡«é»˜è®¤/å½“å‰åŸå¸‚å
      weather.cityName = weather.cityName || currentCity?.name || 'ä¸‡ç§€'
      this.currentWeather = weather

      // è·å–å½“æ—¥æœ€é«˜/æœ€ä½æ°”æ¸©
      try {
        const daily = await getDailyForecast(location, 1)
        if (daily && daily.length > 0) {
          this.highTemp = daily[0].maxTemperature
          this.lowTemp = daily[0].minTemperature
        }
      } catch (e) {
        console.warn('Get daily forecast failed', (e as Error).message)
      }
      
      // è·å–ç©ºæ°”è´¨é‡ï¼ˆä½¿ç”¨ç»çº¬åº¦ï¼‰
      const airQuality = await getAirQuality(latitude, longitude)
      this.aqi = airQuality.aqi
      this.aqiDescription = airQuality.quality
    } catch (error) {
      const errorMsg = (error as Error).message || 'è·å–å¤©æ°”æ•°æ®å¤±è´¥'
      // åˆ¤æ–­æ˜¯å¦æ˜¯403æƒé™é”™è¯¯
      if (errorMsg.includes('403')) {
        this.errorMessage = 'APIæƒé™ä¸è¶³ï¼Œè¯·åœ¨å’Œé£å¤©æ°”æ§åˆ¶å°å¼€é€šå¤©æ°”æ•°æ®æœåŠ¡'
      } else {
        this.errorMessage = errorMsg
      }
    } finally {
      this.isLoading = false
    }
  }
  
  // è·³è½¬åˆ°åŸå¸‚é€‰æ‹©é¡µé¢
  goToCityPage() {
    router.pushUrl({ url: 'pages/city/CityPage' }).catch((err: Error) => {
      console.error('Navigation failed:', err.message)
    })
  }
  
  // è·³è½¬åˆ°48å°æ—¶é¢„æŠ¥é¡µé¢
  goToHourlyForecast() {
    router.pushUrl({ url: 'pages/forecast/HourlyForecastPage' }).catch((err: Error) => {
      console.error('Navigation failed:', err.message)
    })
  }
  
  // è·³è½¬åˆ°7å¤©é¢„æŠ¥é¡µé¢
  goToDailyForecast() {
    router.pushUrl({ url: 'pages/forecast/DailyForecastPage' }).catch((err: Error) => {
      console.error('Navigation failed:', err.message)
    })
  }
  
  // è·³è½¬åˆ°ç©ºæ°”è´¨é‡é¡µé¢
  goToAirQuality() {
    router.pushUrl({ url: 'pages/air/AirQualityPage' }).catch((err: Error) => {
      console.error('Navigation failed:', err.message)
    })
  }
  
  // è·³è½¬åˆ°ç”Ÿæ´»å»ºè®®é¡µé¢
  goToLifeAdvice() {
    router.pushUrl({ url: 'pages/life/LifeAdvicePage' }).catch((err: Error) => {
      console.error('Navigation failed:', err.message)
    })
  }
  
  // è·³è½¬åˆ°é¢„è­¦é¡µé¢
  goToWarnings() {
    router.pushUrl({ url: 'pages/warning/WarningPage' }).catch((err: Error) => {
      console.error('Navigation failed:', err.message)
    })
  }
  
  build() {
    Stack() {
      Image($r('app.media.gradient_bg'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Fill)
      
      Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row()
         {
          // ä¸­é—´ç©ºç™½ï¼Œç”¨äºä¿æŒå±…ä¸­å¸ƒå±€
          Blank().layoutWeight(1)
          
          // å³ä¾§ï¼šåˆ‡æ¢æŒ‰é’®ï¼ˆä¸‹ç§»ä¸€ç‚¹ï¼‰
          Button('åˆ‡æ¢')
            .onClick(() => {
              this.goToCityPage()
            })
            .height(34)
            .backgroundColor('rgba(255,255,255,0.18)')
            .backdropBlur(20)
            .border({ width: 1, color: 'rgba(255,255,255,0.25)' })
            .fontColor(Color.White)
            .fontSize(14)
            .borderRadius(16)
            .width(72)
            .margin({ top: 28 })
            .padding({ left: 8, right: 8 })
        }
      .alignItems(VerticalAlign.Center)
      .padding({ left: 20, right: 60, top: 144, bottom: 12 })
      
      // åŠ è½½ä¸­æç¤º
      if (this.isLoading) {
        Column() {
          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor(Color.White)
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } 
      // é”™è¯¯æç¤º
      else if (this.errorMessage) {
        Column() {
          Text(this.errorMessage)
            .fontColor('#FFD1D1')
            .fontSize(16)
            .textAlign(TextAlign.Center)
          
          Button('é‡è¯•')
            .onClick(() => {
              this.refreshWeather()
            })
            .margin({ top: 20 })
            .backgroundColor('rgba(255,255,255,0.18)')
            .fontColor(Color.White)
            .borderRadius(8)
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .padding(20)
      } 
      // å¤©æ°”ä¿¡æ¯å±•ç¤º
      else {
        Column() {
          // åŸå¸‚åç§°
          Text(this.cityManager.getCurrentCity()?.name || this.currentWeather.cityName || 'æ¢§å·')
            .fontSize(36)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .letterSpacing(2)
            .textAlign(TextAlign.Center)
            .margin({ bottom: 6 })
          
          // å¤©æ°”çŠ¶å†µ
          Text(this.currentWeather.weatherCondition || 'æš‚æ— æ•°æ®')
            .fontSize(18)
            .fontColor(Color.White)
            .textAlign(TextAlign.Center)
            .margin({ bottom: 12 })
          
          // å›¾æ ‡ + æ¸©åº¦ï¼ˆè¶…å¤§å­—å·ï¼‰
          Text(`${this.currentWeather.temperature}Â°C`)
            .fontSize(80)
            .fontWeight(FontWeight.Lighter)
            .fontColor(Color.White)
            .textAlign(TextAlign.Center)
            .margin({ bottom: 12 })
          
          // ä½“æ„Ÿä¸ AQI èŠ¯ç‰‡
          Row() {
            this.buildChip(`ä½“æ„Ÿ ${this.currentWeather.feelsLike}Â°C`)
            Blank().width(8)
            this.buildChip(`AQI ${this.aqi} ${this.aqiDescription}`, this.getAQIColor(this.aqi))
          }
          .justifyContent(FlexAlign.Center)
          .margin({ bottom: 14 })
          
          // å½“æ—¥æœ€é«˜/æœ€ä½æ¸©åº¦
          Text(`ä»Šæ—¥ æœ€é«˜ ${this.formatTemp(this.highTemp)} / æœ€ä½ ${this.formatTemp(this.lowTemp)}`)
            .fontSize(14)
            .fontColor('#E8F3FF')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 16 })
          
          // å…¶ä»–å¤©æ°”ä¿¡æ¯
          Column() {
            Row() {
              this.buildMetricCard('æ¹¿åº¦', `${this.currentWeather.humidity}%`, 'ğŸ’§')
              this.buildMetricCard('é£é€Ÿ', `${this.currentWeather.windSpeed} km/h`, 'ğŸŒ¬ï¸')
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ bottom: 10 })
            
            Row() {
              this.buildMetricCard('æ°”å‹', `${this.currentWeather.pressure} hPa`, 'ğŸ§­')
              this.buildMetricCard('èƒ½è§åº¦', `${this.currentWeather.visibility} km`, 'ğŸ‘ï¸')
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width('90%')
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .padding({ left: 20, right: 20 })
      }
      
      // åŠŸèƒ½å¯¼èˆªæŒ‰é’®åŒºåŸŸ
      if (!this.isLoading && !this.errorMessage) {
        Column() {
          // ç¬¬ä¸€è¡ŒæŒ‰é’®
          Row() {
            Button('48å°æ—¶é¢„æŠ¥')
              .onClick(() => {
                this.goToHourlyForecast()
              })
              .layoutWeight(1)
              .height(40)
              .backgroundColor('rgba(255,255,255,0.2)')
              .backdropBlur(20)
              .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
              .fontColor(Color.White)
              .borderRadius(24)
              .margin({ right: 5 })
            
            Button('7å¤©é¢„æŠ¥')
              .onClick(() => {
                this.goToDailyForecast()
              })
              .layoutWeight(1)
              .height(40)
              .backgroundColor('rgba(255,255,255,0.2)')
              .backdropBlur(20)
              .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
              .fontColor(Color.White)
              .borderRadius(24)
              .margin({ left: 5 })
          }
          .width('90%')
          .margin({ bottom: 10 })
          
          // ç¬¬äºŒè¡ŒæŒ‰é’®
          Row() {
            Button('ç©ºæ°”è´¨é‡')
              .onClick(() => {
                this.goToAirQuality()
              })
              .layoutWeight(1)
              .height(40)
              .backgroundColor('rgba(255,255,255,0.2)')
              .backdropBlur(20)
              .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
              .fontColor(Color.White)
              .borderRadius(24)
              .margin({ right: 5 })
            
            Button('ç”Ÿæ´»å»ºè®®')
              .onClick(() => {
                this.goToLifeAdvice()
              })
              .layoutWeight(1)
              .height(40)
              .backgroundColor('rgba(255,255,255,0.2)')
              .backdropBlur(20)
              .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
              .fontColor(Color.White)
              .borderRadius(24)
              .margin({ left: 5 })
          }
          .width('90%')
          .margin({ bottom: 10 })
          
          // é¢„è­¦æŒ‰é’®
          Row() {
            Button('æç«¯å¤©æ°”é¢„è­¦')
              .onClick(() => {
                this.goToWarnings()
              })
              .width('90%')
              .height(40)
              .backgroundColor('rgba(255,255,255,0.2)')
              .backdropBlur(20)
              .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
              .fontColor(Color.White)
              .borderRadius(24)
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
        .margin({ bottom: 20 })
      }
      
      // åº•éƒ¨åˆ·æ–°æŒ‰é’®
      Row() {
        Button('åˆ·æ–°å¤©æ°”')
          .onClick(() => {
            this.refreshWeather()
          })
          .width('90%')
          .height(40)
          .backgroundColor('rgba(255,255,255,0.2)')
          .backdropBlur(20)
          .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
          .fontColor(Color.White)
          .borderRadius(24)
      }
      .justifyContent(FlexAlign.Center)
      .margin({ top: 10, bottom: 20 })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
  }
  
  // æ ¹æ®AQIå€¼è¿”å›å¯¹åº”é¢œè‰²
  getAQIColor(aqi: number): ResourceColor {
    if (aqi <= 50) {
      return '#1E8E3E' // æ·±ç»¿
    } else if (aqi <= 100) {
      return '#B8860B' // é‡‘é»„ï¼Œè¾ƒæ·±
    } else if (aqi <= 150) {
      return '#FF8C00' // æ·±æ©™
    } else if (aqi <= 200) {
      return '#D93025' // æ·±çº¢
    } else if (aqi <= 300) {
      return '#7E57C2' // æ·±ç´«
    } else {
      return '#6D4C41' // æ·±è¤
    }
  }

  // æ¸©åº¦æ˜¾ç¤ºæ ¼å¼åŒ–
  formatTemp(temp: number): string {
    if (temp === undefined || temp === null) {
      return '--Â°C'
    }
    return `${temp}Â°C`
  }

  // æ°”è±¡è¦ç´ å¡ç‰‡
  @Builder
  buildMetricCard(label: string, value: string, icon: string) {
    Column() {
      Row() {
        Text(icon)
          .fontSize(16)
          .fontColor('#E8F3FF')
          .margin({ right: 6 })
        Text(label)
          .fontSize(14)
          .fontColor('#E8F3FF')
      }
      .margin({ bottom: 8 })
      Text(value)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
    }
    .padding({ top: 18, bottom: 18, left: 20, right: 20 })
    .backgroundColor('rgba(255,255,255,0.20)')
    .backdropBlur(20)
    .border({ width: 1, color: 'rgba(255,255,255,0.3)' })
    .borderRadius(24)
    .shadow({ radius: 12, color: 'rgba(0,0,0,0.12)', offsetX: 0, offsetY: 6 })
    .width('48%')
  }

  // èŠ¯ç‰‡æ ·å¼ï¼ˆä½“æ„Ÿ/AQIï¼‰
  @Builder
  buildChip(text: string, color?: ResourceColor) {
    Text(text)
      .fontSize(14)
      .fontColor(color || '#E8F3FF')
      .padding({ left: 14, right: 14, top: 6, bottom: 6 })
      .backgroundColor('rgba(255,255,255,0.20)')
      .borderRadius(18)
      .shadow({ radius: 8, color: 'rgba(0,0,0,0.12)', offsetX: 0, offsetY: 4 })
  }

  // æ ¹æ®å¤©æ°”/æ˜¼å¤œè¿”å›èƒŒæ™¯è‰²ï¼ˆç”¨äºä¸æ”¯æŒæ¸å˜çš„ç¯å¢ƒï¼‰
  getBackgroundColor(): string {
    const cond = (this.currentWeather.weatherCondition || '').toLowerCase()
    const hour = this.getCurrentHour()
    const isNight = hour >= 19 || hour < 6
    if (isNight) {
      return '#0A2342' // æ·±è“å¤œé—´
    }
    if (cond.includes('é›¨') || cond.includes('rain') || cond.includes('é›·')) {
      return '#5A6478' // ç°è“é›¨å¤©
    }
    if (cond.includes('é›ª') || cond.includes('snow')) {
      return '#6B7A8F' // å†¬æ—¥ç°è“
    }
    if (cond.includes('é˜´') || cond.includes('äº‘') || cond.includes('cloud')) {
      return '#3E5C76' // å¤šäº‘
    }
    return '#4FACFE' // æ™´å¤©é»˜è®¤
  }

  getCurrentHour(): number {
    // ä¼˜å…ˆè§£ææ¥å£æ›´æ–°æ—¶é—´ï¼Œå¦åˆ™å–æœ¬åœ°æ—¶é—´
    const t = this.currentWeather.updateTime
    if (t) {
      const d = new Date(t)
      if (!isNaN(d.getTime())) {
        return d.getHours()
      }
    }
    return new Date().getHours()
  }
}